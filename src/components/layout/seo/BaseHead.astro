---
import { SEO } from "astro-seo";
import { Schema } from "astro-seo-schema";
import { SITE_CONFIG } from '@/config/site';
import type { SiteConfig } from '@/types/site-config';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import '@/styles/global.css';

interface Props {
    config?: SiteConfig;
};

const config = Astro.props.config || SITE_CONFIG;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const metaTitle: string = t(config.title);
const metaName: string = t(config.name);
const metaDescription: string = t(config.description);
const metaKeywords: string = config.keywords.map(key => t(key)).join(', ');
const metaAuthor: string = config.author || "Modus Zero Team";
const metaPublishDate: string = config.publishDate || new Date().toISOString().split('T')[0];

const imagePath: string = config.imageUrl || '/v1-moduszero-og.jpg';
const socialImageURL: string = `${config.siteOrigin}${config.basePrefix}${imagePath.startsWith('/') ? imagePath : '/' + imagePath}`;
const metaImageAlt: string = `${metaName.replace(' ', '_')}_screenshot`;
const canonicalURL: string = `${config.siteOrigin}${config.basePrefix}${Astro.url.pathname.replace(config.basePrefix || '', '')}`.replace(/\/+$/, '/');

const GA_ID: string = "G-7QFXWYM9NE"; 
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href={`${config.basePrefix}/favicon.svg`} />
<meta name="generator" content={Astro.generator} />

<meta name="google-site-verification" content="q435vxRBWwIMVeiEoC8r8-edkuuKc3bEnwLDLty9UnA" />
<meta name="author" content={metaAuthor} />
<meta name="publish_date" property="og:publish_date" content={metaPublishDate} />

<title>{metaTitle}</title>
<meta name="description" content={metaDescription} />
<meta property="og:title" content={metaTitle} />
<meta property="og:description" content={metaDescription} />
<meta property="og:image" content={socialImageURL} />
<meta property="og:image:alt" content={metaImageAlt} />
<meta property="og:image:secure_url" content={socialImageURL} />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content={canonicalURL} />
<meta property="og:type" content="website" />
<meta property="og:site_name" content={metaName} />

<SEO
    title={metaTitle}
    description={metaDescription}
    canonical={canonicalURL}
    twitter={{
        card: "summary_large_image",
        title: metaTitle,
        description: metaDescription,
        image: socialImageURL,
    }}
    extend={{
        meta: [
            { name: "keywords", content: metaKeywords },
            { name: "twitter:image", content: socialImageURL },
            { name: "twitter:creator", content: "@moduszero" },
            { property: "og:image:alt", content: metaImageAlt },
        ],
    }}
/>

<Schema
    item={{
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": metaName,
        "description": metaDescription,
        "url": canonicalURL,
        "image": socialImageURL,
        "author": {
            "@type": "Organization",
            "name": metaName
        },
        "datePublished": metaPublishDate
    }}
/>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet" />

<script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
<script is:inline define:vars={{ GA_ID }}>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  if (localStorage.getItem('cookie-consent') === 'granted') {
    gtag('config', GA_ID);
  } else {
    gtag('consent', 'default', {
      'analytics_storage': 'denied'
    });
    gtag('config', GA_ID);
  }
</script>

<script is:inline>
    (function() {
        const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.classList.toggle('dark', theme === 'dark');
        document.documentElement.style.colorScheme = theme;
    })();
</script>