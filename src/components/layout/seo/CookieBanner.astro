---
import { getLangFromUrl, useTranslations, getI18nPath } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const base = import.meta.env.BASE_URL;
---

<div id="cookie-banner" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[95%] max-w-2xl z-100 hidden animate-in fade-in slide-in-from-bottom-10 duration-700">
  <div class="bg-white/80 dark:bg-mono-darker/80 backdrop-blur-2xl border border-mono-black/10 dark:border-mono-white/10 p-6 rounded-3xl shadow-2xl">
    <div class="flex flex-col md:flex-row items-center gap-6">
      <div class="flex-1">
        <h3 class="text-sm font-bold uppercase tracking-widest text-emerald-500 mb-2">{t('legal.cookies.protocol')}</h3>
        <p class="text-xs text-mono-gray dark:text-mono-light leading-relaxed">
          {t('legal.cookies.description')} 
          <a 
            href={getI18nPath(base, lang, 'legal/cookies')}
            aria-label={t('legal.cookies.title')}
            class="cursor-target underline hover:text-emerald-500 transition-colors"
            >
            {t('legal.cookies.title')}
          </a>.
        </p>
      </div>
      <div class="flex gap-3 w-full md:w-auto">
        <button id="decline-cookies" class="cursor-target flex-1 md:flex-none px-6 py-3 text-[10px] font-bold uppercase tracking-widest opacity-50 hover:opacity-100 transition-opacity">
          {t('legal.cookies.decline')}
        </button>
        <button id="accept-cookies" class="cursor-target flex-1 md:flex-none px-6 py-3 bg-mono-black dark:bg-mono-white text-white dark:text-black rounded-xl text-[10px] font-bold uppercase tracking-[0.2em] hover:scale-105 transition-all shadow-lg">
          {t('legal.cookies.accept')}
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  function setupCookies() {
    const banner = document.getElementById('cookie-banner');

    window.addEventListener('open-cookie-banner', () => {
      banner?.classList.remove('hidden');
    });

    const acceptBtn = document.getElementById('accept-cookies');
    const declineBtn = document.getElementById('decline-cookies');

    if (!localStorage.getItem('cookie-consent')) {
      banner?.classList.remove('hidden');
    }

    const updateConsent = (status) => {
      localStorage.setItem('cookie-consent', status);
      banner?.classList.add('hidden');
      
      if (status === 'granted') {
        window.gtag('consent', 'update', { 'analytics_storage': 'granted' });
      }
    };

    acceptBtn?.addEventListener('click', () => updateConsent('granted'));
    declineBtn?.addEventListener('click', () => updateConsent('denied'));
  }

  setupCookies();
  document.addEventListener('astro:page-load', setupCookies);
</script>